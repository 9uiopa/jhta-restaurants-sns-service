<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.jhta.restaurants_service.mapper.ReviewMapper">


	<insert id="insertReview" parameterType="Review">
	  insert into REVIEWS
	  (rating, content, customer_id, store_id)
	  values
	  (#{rating}, #{content}, #{customer.id}, #{store.id})
	  <selectKey keyProperty="id" resultType="int" order="AFTER">
           SELECT LAST_INSERT_ID()
      </selectKey>
	</insert>
	
	<select id="getReviewById" parameterType="int" resultType="Review">
		select 
			id,			
			rating,
			content,
			create_date		as 	createDate,
			update_date		as	updateDate,
			liked_count		as	likedCount,
			report_count	as  reportCount,
			disabled,
			blocked,
			customer_id		as "customer.id",		
			store_id		as "store.id"
		from 
			REVIEWS
		where 
			id = #{value};
	</select>
	
	<select id="getAllReviewsByCustomerId" parameterType="int" resultType="Review">
		select 
			id,			
			rating,
			content,
			create_date		as 	createDate,
			update_date		as	updateDate,
			liked_count		as	likedCount,
			report_count	as  reportCount,
			disabled,
			blocked,
			customer_id		as "customer.id",		
			store_id		as "store.id"
		from 
			REVIEWS
		where customer_id = #{value}
		order by update_date desc;
	</select>

	<select id="getReviewByCustomerId" parameterType="int" resultType="Review">
		select 
			id,			
			rating,
			content,
			create_date		as 	createDate,
			update_date		as	updateDate,
			liked_count		as	likedCount,
			report_count	as  reportCount,
			disabled,
			blocked,
			customer_id		as "customer.id",		
			store_id		as "store.id"
		from 
			REVIEWS
		where 
			customer_id = #{value};
	</select>
	<select id="getAllReviewsByStoreId" parameterType="int" resultType="Review">
		select 
			id,			
			rating,
			content,
			create_date		as 	createDate,
			update_date		as	updateDate,
			liked_count		as	likedCount,
			report_count	as  reportCount,
			disabled,
			blocked,
			customer_id		as "customer.id",		
			store_id		as "store.id"
		from 
			REVIEWS
		where store_id = #{value}
		order by update_date desc;
	</select>
<!--	
	<resultMap id="ReviewResultMap" type="kr.co.jhta.restaurants_service.dto.ReviewDto">
	    <id column="id" property="id" />
	    <result column="rating" property="rating" />
	    <result column="content" property="content" />
	    <result column="create_date" property="createDate" />
	    <result column="update_date" property="updateDate" />
	    <result column="liked_count" property="likedCount" />
	    <result column="report_count" property="reportCount" />
	    <result column="disabled" property="disabled" />
	    <result column="blocked" property="blocked" />
	    <result column="review_avg" property="reviewAvg" />
	    <association property="customer" javaType="kr.co.jhta.restaurants_service.vo.user.User">
	        <id column="customer_id" property="id" />
	        <result column="nickname" property="nickname" />
	        <result column="username" property="username" />
	    </association>
		<collection property="reviewPictures" javaType="kr.co.jhta.restaurants_service.vo.review.ReviewPicture">
	        <id column="picture_id" property="id"/>
	        <result column="picture_name" property="pictureName" />
	    </collection>
	    <collection property="reviewKeywords" javaType="kr.co.jhta.restaurants_service.vo.review.ReviewKeyword">
	        <id column="review_keyword_id" property="id"/>
	        <result column="keyword" property="keyword" /> 
	    </collection> 
    
	</resultMap>
	
	<select id="getAllReviewsByStoreId" parameterType="int" resultMap="ReviewResultMap">
			SELECT 
	   		R.id,			
		    R.rating,
		    R.content,
		    R.create_date,
		    R.update_date,
		    R.liked_count,
		    R.report_count,
		    R.disabled,
		    R.blocked,
		    R.store_id,
		    R.customer_id,
		    U.nickname,
		    U.username,
		    A.review_avg 
			P.id AS picture_id,
		    P.picture_name, 
		    K.id AS review_keyword_id,
		    K.keyword 
		FROM USERS U
		LEFT OUTER JOIN REVIEWS R ON U.id = R.customer_id
		LEFT OUTER JOIN REVIEW_PICTURES P ON R.id = P.review_id 
		LEFT OUTER JOIN REVIEW_KEYWORDS K ON R.id = K.review_id 
		LEFT OUTER JOIN (
		    SELECT 
		        customer_id,
		        AVG(rating) AS review_avg
		    FROM REVIEWS
		    GROUP BY customer_id
		) A ON U.id = A.customer_id
		WHERE R.store_id = #{value}
		ORDER BY R.update_date DESC;
	</select>
-->	
	<select id="getReviewByStoreId" parameterType="int" resultType="Review">
		select 
			id,			
			rating,
			content,
			create_date		as 	createDate,
			update_date		as	updateDate,
			liked_count		as	likedCount,
			report_count	as  reportCount,
			disabled,
			blocked,
			customer_id		as "customer.id",		
			store_id		as "store.id"
		from 
			REVIEWS
		where 
			store_id = #{value};
	</select>
	
	<select id="getAllReviewRatingByStoreId" parameterType="int" resultType="ReviewSummaryDto">
		select 
			SUM(CASE WHEN RATING = 1 THEN 1 ELSE 0 END) as bad,
			SUM(CASE WHEN RATING = 3 THEN 1 ELSE 0 END) as soso,
			SUM(CASE WHEN RATING = 5 THEN 1 ELSE 0 END) as good
		from REVIEWS
		where store_id = #{value};	
	</select>

	<select id="getReviewsPaginatedByStoreId" resultType="ReviewDto">
		SELECT
		r.id AS id,
		r.rating AS rating,
		r.content AS content,
		r.create_date AS createDate,
		r.liked_count AS likedCount,
		r.report_count AS reportCount,
		r.customer_id AS customerId,
		u.username AS customerUsername
		FROM REVIEWS r
		JOIN USERS u ON r.customer_id = u.id
		WHERE r.store_id = #{storeId}
		ORDER BY r.create_date DESC
		LIMIT #{begin}, #{end}
	</select>
</mapper>