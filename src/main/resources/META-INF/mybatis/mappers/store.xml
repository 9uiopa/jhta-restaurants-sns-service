<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.jhta.restaurants_service.mapper.StoreMapper">

<!-- 	<select id = "getAllStores" resultType="Store"> -->
<!-- 		select -->
<!-- 			business_license	as businessLicense, -->
<!-- 			name				as name, -->
<!-- 			address				as address, -->
<!-- 			category			as category, -->
<!-- 			zipcode				as zipcode, -->
<!-- 			latitude			as latitude, -->
<!-- 			longitude			as longitude, -->
<!-- 			description			as description, -->
<!-- 			phone				as phone, -->
<!-- 			read_count			as readCount, -->
<!-- 			create_date			as createDate, -->
<!-- 			update_date			as updateDate, -->
<!-- 			owner_id			as "owner.id", -->
<!-- 			disabled			as disabled -->

<!-- 		from -->
<!-- 			STORES -->
<!-- 	</select> -->


	<select id = "getStores" parameterType="map" resultType="SearchedStore">
		select *
		from (
						select
				            id      			as id,
				            name    			as name,
				           	review_avg			as reviewAvg,
				           	review_cnt			as reviewCnt,
				           	bookmark_cnt		as bookmarkCnt,
				           	category			as category,
				           	latitude			as latitude,
				           	longitude			as longitude,				           	
							<choose>
								<when test="sort == 'rating'">
									row_number() over (order by review_avg desc) row_num
								</when>
								<when test="sort == 'bookmark'">
									row_number() over (order by bookmark_cnt desc) row_num
								</when>
								<when test="sort == 'review'">
									row_number() over (order by review_cnt desc) row_num
								</when>
							</choose>
				        from
				        	 (select distinct id,
				        	 		S.name,
				        	 		category,
				        	 		IFNULL(review_cnt,0) review_cnt,
				        	 		IFNULL(review_avg,0) review_avg,
				        	 		IFNULL(bookmark_cnt,0) bookmark_cnt,
				        	 		S.latitude,
				        	 		S.longitude  
				        	 	
				        	 from
					        	   STORES S left join 
					        	   (select 
						        	 	store_id, 
						        	 	AVG(rating) as review_avg, 
						        	 	COUNT(*) as review_cnt
							        from REVIEWS
							        group by store_id
						           ) R on S.id = R.store_id
						        	 
						        	 left join
						        	 (
						        	 	select
							        	 	store_id,
							        	 	COUNT(*) as bookmark_cnt
						        	 	
							        	from BOOKMARKS
							        	group by store_id
						        	 ) B on S.id = B.store_id
						        	 	left join
						        	 	(
						        	 		select
						        	 			store_id,
						        	 			F.name
						        	 		from FOODS F
						        	 	) F on S.id = F.store_id
							<where>
								<if test="category != null">
								     S.category =  #{category}
							    </if>
							   
								<if test="keyword != null">
									and
									(S.name like CONCAT('%', #{keyword}, '%')
									or F.name like CONCAT('%', #{keyword}, '%')
									or S.address like CONCAT('%', #{keyword}, '%'))
								</if>
								
								<if test="xStart != null">
									and 
									(#{xStart} &lt; S.longitude) and (S.longitude &lt; #{xEnd}) and
									(#{yStart} &lt; S.latitude) and (S.latitude &lt; #{yEnd})
								</if>
							    
							</where>
							) as RAW
						   
			) as RESULT
		
		where row_num between #{begin} and #{end};

	</select>



	<!--키워드검색,  카테고리화 할때 전체 row 자체가 해당 되는 row만 잡혀야함 -->
	<select id="getTotalRows" parameterType="map" resultType="int">
	  select count(distinct S.id)
	  from STORES S left join
	  	FOODS F on S.id = F.store_id
	  <where>
		<if test="category != null">
			     S.category =  #{category}
		</if>
		<if test="keyword != null">
			and
			(S.name like CONCAT('%', #{keyword}, '%')
			or F.name like CONCAT('%', #{keyword}, '%')
			or S.address like CONCAT('%', #{keyword}, '%'))
			
		</if>
		<if test="xStart != null">
			and 
			(#{xStart} &lt; S.longitude) and (S.longitude &lt; #{xEnd}) and
			(#{yStart} &lt; S.latitude) and (S.latitude &lt; #{yEnd})
		</if>
	  </where>
	</select>

	<select id="getStoreById" parameterType="int" resultType="Store">
		select
			id 					as id,
			business_license	as businessLicense,
			name				as name,
			address				as address,
			category			as category,
			zipcode				as zipcode,
			latitude			as latitude,
			longitude			as longitude,
			description			as description,
			phone				as phone,
			read_count			as readCount,
			create_date			as createDate,
			update_date			as updateDate,
			owner_id			as "owner.id",
			disabled			as disabled
		from
			STORES
		where id = #{value}
	</select>
	
	<select id="getStoreByName" parameterType="String" resultType="Store">
		select
			id 					as id,
			business_license	as businessLicense,
			name				as name,
			address				as address,
			category			as category,
			zipcode				as zipcode,
			latitude			as latitude,
			longitude			as longitude,
			description			as description,
			phone				as phone,
			read_count			as readCount,
			create_date			as createDate,
			update_date			as updateDate,
			owner_id			as "owner.id",
			disabled			as disabled
		from
			STORES
		where name like  concat(#{value}, '%')
	</select>
	
	<select id="getAllStores" resultType="Store">
		select
			id 					as id,
			business_license	as businessLicense,
			name				as name,
			address				as address,
			category			as category,
			zipcode				as zipcode,
			latitude			as latitude,
			longitude			as longitude,
			description			as description,
			phone				as phone,
			read_count			as readCount,
			create_date			as createDate,
			update_date			as updateDate,
			owner_id			as "owner.id",
			disabled			as disabled
		from
			STORES
	</select>
</mapper>